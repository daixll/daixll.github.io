#include <sys/socket.h>
#include <arpa/inet.h>
#include <unistd.h>

#include <sys/epoll.h>
#include <fcntl.h>

#include <thread>

#include <string.h>
#include <iostream>
#include <string>

void é”™è¯¯(bool æ ‡å¿—, std::string é”™è¯¯ä¿¡æ¯){
    if(!æ ‡å¿—) return ;  // å¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œç›´æ¥è¿”å›
    std::cerr<<é”™è¯¯ä¿¡æ¯<<errno<<"\n";
    exit(0);
}

bool è­¦å‘Š(bool æ ‡å¿—, std::string è­¦å‘Šä¿¡æ¯){
    if(!æ ‡å¿—) return 0;  // å¦‚æœæ²¡æœ‰è­¦å‘Šï¼Œè¿”å› 0
    std::cerr<<è­¦å‘Šä¿¡æ¯<<errno<<"\n";
    return 1;
}

int å¥—æ¥å­—(std::string IPåœ°å€, int ç«¯å£){
    int ğŸ˜‚ = socket(AF_INET, SOCK_STREAM, 0);
    é”™è¯¯(ğŸ˜‚ == -1, "socketåˆ›å»ºé”™è¯¯");

    sockaddr_in åœ°å€;
    memset(&åœ°å€, 0, sizeof åœ°å€);
    åœ°å€.sin_family      = AF_INET;
    åœ°å€.sin_addr.s_addr = inet_addr(IPåœ°å€.c_str());
    åœ°å€.sin_port        = htons(ç«¯å£);
    int ç«¯å£å¤ç”¨ = 1;    // ç«¯å£å¤ç”¨
    setsockopt(ğŸ˜‚, SOL_SOCKET, SO_REUSEADDR, (const void *)&ç«¯å£å¤ç”¨, sizeof(ç«¯å£å¤ç”¨));
    é”™è¯¯(
        bind(ğŸ˜‚, (sockaddr*)&åœ°å€, sizeof åœ°å€) == -1,
        "ç»‘å®šæœåŠ¡ç«¯åœ°å€é”™è¯¯"
    );
    fcntl(ğŸ˜‚, F_SETFL, O_NONBLOCK); // è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼
    return ğŸ˜‚;
}

void æ¥æ”¶æ•°æ®(int å®¢æˆ·ç«¯, int äº‹ä»¶æ ‘){
    char ç¼“å†²åŒº[1024];
    while(1){
        memset(ç¼“å†²åŒº, '\0', sizeof ç¼“å†²åŒº);
        // æ¥æ”¶æ•°æ® recvä¸æ–­è·å–æ•°æ®ï¼Œå®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€è¿æ¥
        int é•¿åº¦ = recv(å®¢æˆ·ç«¯, ç¼“å†²åŒº, sizeof ç¼“å†²åŒº, 0);
        if(é•¿åº¦ > 0){
            std::cout<<"ã€"<<å®¢æˆ·ç«¯<<"ã€‘ "<<"æ•°æ®é•¿åº¦ï¼š"<<é•¿åº¦<<" å†…å®¹ï¼š"<<ç¼“å†²åŒº<<"\n";
        } else if(é•¿åº¦ == -1 && errno == EINTR){    // ä¿¡å·ä¸­æ–­è¿”å›ï¼Œæ²¡æœ‰ä»»ä½•æ•°æ®å¯ç”¨ï¼Œæ­£å¸¸ï¼Œç»§ç»­
            continue;
        } else if(é•¿åº¦ == -1 && ((errno == EAGAIN) || (errno == EWOULDBLOCK))){  
            //std::cout<<"å®Œæˆä¸€æ¬¡è¯»å–\n";            // éé˜»å¡æ¨¡å¼ä¸‹å®Œæˆä¸€æ¬¡è¯»å–ï¼Œæ­£å¸¸ï¼Œç»§ç»­
            //std::cout<<"-------------------------------------------------\n";
            break;
        } else if(é•¿åº¦ == 0){
            std::cout<<"æ–­å¼€è¿æ¥\n";
            close(å®¢æˆ·ç«¯);
            break;
        }
    }
    return ;
}

void å‘é€æ•°æ®(int å®¢æˆ·ç«¯){
    char ç¼“å†²åŒº[1024];
    while(1){
        memset(ç¼“å†²åŒº, '\0', sizeof ç¼“å†²åŒº);
        std::cin>>ç¼“å†²åŒº;
        // å‘é€æ•°æ® sendä¸æ–­å‘é€æ•°æ®ï¼Œå®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€è¿æ¥
        send(ç¼“å†²åŒº[0]-'0', ç¼“å†²åŒº, strlen(ç¼“å†²åŒº), 0);
    }
}

int main(){
    int æœåŠ¡ç«¯ = å¥—æ¥å­—("0.0.0.0", 8080);
    é”™è¯¯( listen(æœåŠ¡ç«¯, 5) == -1, "ç›‘å¬é”™è¯¯" );

    int äº‹ä»¶æ ‘ = epoll_create1(0);
    é”™è¯¯( äº‹ä»¶æ ‘ == -1, "epollåˆ›å»ºé”™è¯¯" );

    epoll_event äº‹ä»¶, äº‹ä»¶åˆ—è¡¨[1024];

    memset(&äº‹ä»¶, 0, sizeof äº‹ä»¶);
    äº‹ä»¶.data.fd = æœåŠ¡ç«¯;  // ç›‘å¬æœåŠ¡ç«¯
    äº‹ä»¶.events = EPOLLIN | EPOLLET;  // ç›‘å¬å¯è¯»äº‹ä»¶
    é”™è¯¯(
        epoll_ctl(äº‹ä»¶æ ‘, EPOLL_CTL_ADD, æœåŠ¡ç«¯, &äº‹ä»¶) == -1,
        "æœåŠ¡ç«¯æ³¨å†Œäº‹ä»¶é”™è¯¯"
    );

    std::thread( å‘é€æ•°æ®, 0).detach(); // ä¸€ä¸ªçº¿ç¨‹è´Ÿè´£æ‰€æœ‰çš„å‘é€

    while(1){
        int äº‹ä»¶æ•°é‡ = epoll_wait(äº‹ä»¶æ ‘, äº‹ä»¶åˆ—è¡¨, 1024, -1);
        é”™è¯¯(äº‹ä»¶æ•°é‡ == -1, "äº‹ä»¶æ ‘ç­‰å¾…é”™è¯¯");

        //std::cout<<"äº‹ä»¶æ•°é‡ï¼š"<<äº‹ä»¶æ•°é‡<<"\n";
        for(int i=0; i<äº‹ä»¶æ•°é‡; i++){
            if(äº‹ä»¶åˆ—è¡¨[i].data.fd == æœåŠ¡ç«¯){
                sockaddr_in å®¢æˆ·ç«¯åœ°å€;
                memset(&å®¢æˆ·ç«¯åœ°å€, ' ', sizeof å®¢æˆ·ç«¯åœ°å€);
                socklen_t å®¢æˆ·ç«¯åœ°å€å¤§å° = sizeof å®¢æˆ·ç«¯åœ°å€;
                int å®¢æˆ·ç«¯ = accept(æœåŠ¡ç«¯, (sockaddr*)&å®¢æˆ·ç«¯åœ°å€, &å®¢æˆ·ç«¯åœ°å€å¤§å°);
                if( è­¦å‘Š( å®¢æˆ·ç«¯==-1, "æ¥å—å®¢æˆ·ç«¯è¿æ¥é”™è¯¯") ) continue;
                fcntl(å®¢æˆ·ç«¯, F_SETFL, O_NONBLOCK); // è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼
                std::cout<<"ã€"<<å®¢æˆ·ç«¯<<"ã€‘ "<<"æ–°çš„è¿æ¥ "<<"ipï¼š"<<inet_ntoa(å®¢æˆ·ç«¯åœ°å€.sin_addr)<<"\n";
                std::cout<<"-------------------------------------------------\n";

                memset(&äº‹ä»¶, 0, sizeof äº‹ä»¶);
                äº‹ä»¶.data.fd = å®¢æˆ·ç«¯;  // ç›‘å¬å®¢æˆ·ç«¯
                äº‹ä»¶.events = EPOLLIN | EPOLLOUT | EPOLLET;  // å¯è¯»å¯å†™äº‹ä»¶
                é”™è¯¯(
                    epoll_ctl(äº‹ä»¶æ ‘, EPOLL_CTL_ADD, å®¢æˆ·ç«¯, &äº‹ä»¶) == -1,
                    "å®¢æˆ·ç«¯æ³¨å†Œäº‹ä»¶é”™è¯¯"
                );
            }
            else if(äº‹ä»¶åˆ—è¡¨[i].events & EPOLLIN){
                // åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥è¯»
                std::thread( æ¥æ”¶æ•°æ®, int(äº‹ä»¶åˆ—è¡¨[i].data.fd), äº‹ä»¶æ ‘).detach();
            }
            /*
            else if(äº‹ä»¶åˆ—è¡¨[i].events & EPOLLOUT){
                // åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥å†™
                std::thread( å‘é€æ•°æ®, int(äº‹ä»¶åˆ—è¡¨[i].data.fd), äº‹ä»¶æ ‘).detach();
            }
            (*/
        }
    }

    return 0;
}